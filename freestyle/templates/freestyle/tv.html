{% load static %}
<!doctype html>
<html lang="en" data-channel="{{ channel.slug|default:'main' }}">
<head>
  <meta charset="utf-8" />
  <title>Freestyle TV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; overflow:hidden; }
    #player { width:100vw; height:100vh; background:#000; object-fit:contain; }
    .badge { position:fixed; top:10px; left:10px; z-index:9999; display:flex; gap:8px; flex-wrap:wrap; }
    .badge a{ color:#fff; font-family:Arial,sans-serif; font-size:14px; background:rgba(0,0,0,.45); padding:8px 10px; border-radius:8px; text-decoration:none; }

    #logo{
      position:fixed; top:14px; right:14px; height:320px; width:auto;
      z-index:9999; pointer-events:none; opacity:.98;
      filter: drop-shadow(0 0 20px rgba(0,170,255,.35)) drop-shadow(0 0 60px rgba(0,170,255,.18));
      animation: glow 3.2s ease-in-out infinite;
      transform-origin: 50% 50%;
    }
    @keyframes glow{
      0%,100%{ filter: drop-shadow(0 0 14px rgba(0,170,255,.20)) drop-shadow(0 0 42px rgba(0,170,255,.12)); }
      50%{ filter: drop-shadow(0 0 28px rgba(0,170,255,.65)) drop-shadow(0 0 95px rgba(0,170,255,.26)); }
    }

    .tv-controls{
      position:fixed; bottom:14px; left:14px; z-index:9999;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:12px;
      background:rgba(0,0,0,.40); backdrop-filter: blur(6px);
    }
    .tv-btn{
      color:#fff; font-family:Arial,sans-serif; font-size:14px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(255,255,255,.06);
      padding:8px 10px; border-radius:10px;
      cursor:pointer; user-select:none;
    }
    .tv-vol{ display:flex; align-items:center; gap:8px; color:#fff; font-family:Arial; font-size:13px; }
    .tv-vol input[type="range"]{ width:150px; cursor:pointer; }

    #qualityHud{
      position:fixed; left:14px; bottom:78px; z-index:9999;
      padding:8px 10px; border-radius:999px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.14);
      color:#fff; font-family:Arial,sans-serif; font-size:12px; font-weight:900;
      letter-spacing:.2px;
      pointer-events:none;
    }

    #viewerPill{
      position:fixed; right:14px; bottom:260px; z-index:9000;
      display:flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:999px;
      background: rgba(0,0,0,.40);
      backdrop-filter: blur(10px);
      border:1px solid rgba(255,255,255,.10);
      color:#fff; font-weight:900;
      box-shadow: 0 14px 40px rgba(0,0,0,.50);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    #chatDock{
      position:fixed; right:14px; bottom:14px; z-index:9999;
      width:min(360px, 94vw);
      border-radius:16px;
      background: rgba(0,0,0,.40);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0,170,255,.18);
      box-shadow: 0 14px 50px rgba(0,0,0,.55);
      overflow:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    #chatHeader{
      padding:10px 12px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: linear-gradient(90deg, rgba(0,170,255,.10), rgba(0,0,0,0));
      color:#fff; font-weight:900; letter-spacing:.3px;
    }
    #chatMeta{ font-size:12px; opacity:.8; font-weight:700; display:flex; align-items:center; gap:10px; }
    #chatCloseBtn{
      border:none; background: rgba(255,255,255,.08);
      color:#fff; font-weight:900;
      border-radius:10px; padding:6px 10px;
      cursor:pointer;
    }

    #reactionBar{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      color:#fff;
    }
    .rxBtns{ display:flex; gap:10px; align-items:center; }
    .rxBtn{
      display:flex; align-items:center; gap:8px;
      border-radius:12px;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
      font-weight:900;
      transition: transform .08s ease;
      color:#fff;
    }
    .rxBtn:active{ transform: scale(.98); }
    .rxBtn[disabled]{ opacity:.45; cursor:not-allowed; }
    .rxCount{ opacity:.95; font-weight:900; }
    .rxNote{ font-size:12px; opacity:.75; font-weight:800; white-space:nowrap; }

    #chatList{ height:220px; overflow:auto; padding:10px 10px 6px 10px; color:#fff; }
    .msg{ padding:8px 10px; border-radius:12px; margin-bottom:8px; background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.06); }
    .msg .u{ font-weight:900; color: rgba(0,170,255,.95); }
    .msg .t{ font-weight:700; opacity:.92; margin-left:6px; }
    #chatInputWrap{ padding:10px; border-top:1px solid rgba(255,255,255,.08); display:flex; gap:8px; }
    #chatInput{
      flex:1; border-radius:12px; border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35); color:#fff; padding:10px 10px; outline:none; font-weight:700;
    }
    #sendBtn{
      border-radius:12px; padding:10px 12px;
      border:1px solid rgba(0,170,255,.35);
      background: rgba(0,170,255,.14);
      color:#fff; font-weight:900; cursor:pointer;
    }

    #chatOpenBtn{
      position:fixed; right:14px; bottom:14px; z-index:9999;
      display:none;
      border-radius:14px; padding:10px 12px;
      border:1px solid rgba(0,170,255,.35);
      background: rgba(0,170,255,.14);
      color:#fff; font-weight:900; cursor:pointer;
      box-shadow: 0 14px 50px rgba(0,0,0,.55);
    }

    body.chat-closed #viewerPill{ bottom:14px; right:92px; }

    @media (max-width: 520px){
      #logo{ height:220px; }
      #chatDock{ right:10px; left:10px; width:auto; bottom:10px; }
      #viewerPill{ right:10px; bottom:78px; }
      body.chat-closed #viewerPill{ bottom:10px; right:90px; }
      #chatOpenBtn{ right:10px; bottom:10px; }
      .tv-controls{ left:10px; bottom:10px; }
      #qualityHud{ left:10px; bottom:74px; }
    }

    #gate{
      position:fixed; inset:0; z-index:20000;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.72);
      backdrop-filter: blur(10px);
    }
    .gate-card{
      width:min(640px, 92vw);
      background: rgba(10,10,10,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:18px;
      color:#fff;
      font-family: Arial, sans-serif;
      text-align:center;
      box-shadow: 0 10px 40px rgba(0,0,0,.55);
    }
    .gate-logo{ display:flex; justify-content:center; margin: 4px 0 12px; }
    .gate-logo img{
      width:min(520px, 88vw);
      height:auto;
      filter: drop-shadow(0 0 26px rgba(0,170,255,.25)) drop-shadow(0 0 80px rgba(0,170,255,.12));
      opacity:.98;
    }
    .gate-card h2{ margin:0 0 8px 0; font-size:22px; }
    .gate-terms{
      text-align:left; font-size:13px; opacity:.92; line-height:1.35;
      max-height:190px; overflow:auto;
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px; padding:10px; margin:12px 0;
      background: rgba(0,0,0,.25);
    }
    #enterBtn{
      padding:10px 14px; border-radius:12px;
      background: rgba(0,170,255,.18);
      border:1px solid rgba(0,170,255,.45);
      color:#fff; font-weight:800;
      cursor:not-allowed; opacity:.45;
      width:100%;
    }
    #enterBtn.enabled{ cursor:pointer; opacity:1; }

    .bubble{
      position:fixed; right:40px; bottom:220px; z-index:12000;
      font-size:30px; filter: drop-shadow(0 10px 30px rgba(0,0,0,.65));
      animation: floatUp 1.1s ease-out forwards;
      pointer-events:none;
    }
    @keyframes floatUp{
      0%{ transform: translateY(0) scale(1); opacity:1; }
      100%{ transform: translateY(-120px) scale(1.25); opacity:0; }
    }
  </style>
</head>

<body>
  <div class="badge">
    <a href="/freestyle/submit/">Submit</a>
    <a href="/freestyle/access/?next=/admin/">Manage (staff)</a>
    <a href="/freestyle/access/?next=/freestyle/creator/">Creator</a>
  </div>

  <img id="logo" src="{% static 'freestyle/img/logo.png' %}" alt="Logo" />

  <video
    id="player"
    playsinline
    preload="auto"
    muted
    autoplay
    controlslist="nodownload noplaybackrate noremoteplayback"
    disablepictureinpicture
  ></video>

  <div class="tv-controls">
    <button id="muteBtn" class="tv-btn" type="button">Unmute</button>
    <div class="tv-vol">
      <span>Vol</span>
      <input id="volSlider" type="range" min="0" max="1" step="0.01" value="0.8" />
    </div>
    <button id="fsBtn" class="tv-btn" type="button">Fullscreen</button>
  </div>

  <div id="qualityHud">Quality: ‚Äî</div>

  <div id="viewerPill">
    <span>üëÅ</span>
    <span id="viewerCount">1100</span>
    <span style="opacity:.85; font-weight:800;">watching</span>
  </div>

  <button id="chatOpenBtn" type="button">Chat</button>

  <div id="chatDock">
    <div id="chatHeader">
      <div>LIVE CHAT</div>
      <div id="chatMeta">
        <span id="chatUser">Guest-‚Ä¶</span>
        <button id="chatCloseBtn" type="button">‚úï</button>
      </div>
    </div>

    <div id="reactionBar">
      <div class="rxBtns">
        <button id="fireBtn" class="rxBtn" type="button"><span>üî•</span> <span>Fire</span> <span class="rxCount" id="fireCount">0</span></button>
        <button id="nahBtn"  class="rxBtn" type="button"><span>üö´</span> <span>Nah</span>  <span class="rxCount" id="nahCount">0</span></button>
      </div>
      <div class="rxNote" id="rxNote">Vote once per video</div>
    </div>

    <div id="chatList"></div>

    <div id="chatInputWrap">
      <input id="chatInput" placeholder="Say something‚Ä¶" maxlength="280" />
      <button id="sendBtn" type="button">Send</button>
    </div>
  </div>

  <div id="gate">
    <div class="gate-card">
      <div class="gate-logo">
        <img src="{% static 'freestyle/img/logo.png' %}" alt="Logo" />
      </div>

      <h2>Tap to Enter</h2>
      <div style="opacity:.92">Confirm you agree to our Terms before entering.</div>

      <div class="gate-terms">
        <b>Terms Summary (example)</b><br/>
        ‚Ä¢ You confirm you have rights to upload content.<br/>
        ‚Ä¢ You grant us a worldwide, royalty-free license to host, stream, promote, and monetize it.<br/>
        ‚Ä¢ No illegal or infringing uploads.<br/>
        ‚Ä¢ We may remove content at any time.<br/><br/>
        <i>Replace this with your real Terms/Privacy links later.</i>
      </div>

      <label style="display:flex; gap:10px; align-items:flex-start; text-align:left; font-size:13px;">
        <input id="agreeBox" type="checkbox" style="margin-top:3px;" />
        <span>I agree to the Terms, Privacy, and Content Policy.</span>
      </label>

      <button id="enterBtn" type="button" style="margin-top:12px;" disabled>Enter (Enable Audio)</button>
      <div style="font-size:12px; opacity:.7; margin-top:8px;">(TV keeps running. This only unlocks audio.)</div>
    </div>
  </div>

  <script>
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return "";
    }
    const CSRF_TOKEN = getCookie("csrftoken");

    const CHANNEL = (document.documentElement.dataset.channel || "main").trim();

    // Keep using the API route (works on local + render)
    const NOW_URL = `/api/freestyle/channel/${encodeURIComponent(CHANNEL)}/now.json`;

    const CHAT_POLL_URL = (afterId) =>
      `/api/freestyle/channel/${encodeURIComponent(CHANNEL)}/chat/messages.json?after_id=${afterId||0}`;
    const CHAT_SEND_URL =
      `/api/freestyle/channel/${encodeURIComponent(CHANNEL)}/chat/send.json`;
    const REACTION_STATE_URL = (videoId) =>
      `/api/freestyle/channel/${encodeURIComponent(CHANNEL)}/reactions/state.json?video_id=${encodeURIComponent(videoId)}`;
    const REACTION_VOTE_URL =
      `/api/freestyle/channel/${encodeURIComponent(CHANNEL)}/reactions/vote.json`;
    const PRESENCE_PING_URL = (sid) =>
      `/api/freestyle/presence/ping.json?sid=${encodeURIComponent(sid)}&channel=${encodeURIComponent(CHANNEL)}`;

    const durationSaveUrl = (videoId) =>
      `/api/freestyle/video/${encodeURIComponent(videoId)}/duration.json`;

    const POLL_MS = 2500;
    const CHAT_POLL_MS = 1500;
    const VIEW_BASE = 1100;
    const SEEK_FORWARD_IF_BEHIND_SEC = 8;

    const videoEl = document.getElementById("player");
    const muteBtn = document.getElementById("muteBtn");
    const volSlider = document.getElementById("volSlider");
    const fsBtn = document.getElementById("fsBtn");
    const qualityHud = document.getElementById("qualityHud");
    const viewerCountEl = document.getElementById("viewerCount");

    const chatDock = document.getElementById("chatDock");
    const chatOpenBtn = document.getElementById("chatOpenBtn");
    const chatCloseBtn = document.getElementById("chatCloseBtn");
    const chatUserEl = document.getElementById("chatUser");
    const chatList = document.getElementById("chatList");
    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");

    const fireBtn   = document.getElementById("fireBtn");
    const nahBtn    = document.getElementById("nahBtn");
    const fireCount = document.getElementById("fireCount");
    const nahCount  = document.getElementById("nahCount");
    const rxNote    = document.getElementById("rxNote");

    function setQuality(text){ qualityHud.textContent = text; }
    function updateMuteBtn(){ muteBtn.textContent = videoEl.muted ? "Unmute" : "Mute"; }

    function escapeHtml(s){
      return (s || "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function getGuestName(){
      let g = localStorage.getItem("fs_guest_name");
      if (!g){
        g = "Guest-" + Math.floor(1000 + Math.random()*9000);
        localStorage.setItem("fs_guest_name", g);
      }
      return g;
    }
    const GUEST = getGuestName();
    chatUserEl.textContent = GUEST;

    function getSid(){
      let sid = sessionStorage.getItem("fs_sid");
      if (!sid){
        sid = (crypto?.randomUUID?.() || ("sid_" + Math.random().toString(16).slice(2) + Date.now().toString(16)));
        sessionStorage.setItem("fs_sid", sid);
      }
      return sid;
    }
    const SID = getSid();

    function getClientId(){
      let cid = localStorage.getItem("fs_client_id");
      if (!cid){
        cid = "cid_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
        localStorage.setItem("fs_client_id", cid);
      }
      return cid;
    }
    const CLIENT_ID = getClientId();

    // ---------- overlay ----------
    const gateEl = document.getElementById("gate");
    const agreeBox = document.getElementById("agreeBox");
    const enterBtn = document.getElementById("enterBtn");

    function setEnterEnabled(on){
      enterBtn.disabled = !on;
      enterBtn.classList.toggle("enabled", !!on);
    }
    setEnterEnabled(false);
    agreeBox.addEventListener("change", () => setEnterEnabled(agreeBox.checked));

    enterBtn.addEventListener("click", async () => {
      gateEl.style.display = "none";
      videoEl.muted = false;
      updateMuteBtn();
      try { await videoEl.play(); } catch(e) {}
    });

    // ---------- controls ----------
    videoEl.muted = true;
    videoEl.volume = parseFloat(volSlider.value || "0.8");
    updateMuteBtn();

    muteBtn.addEventListener("click", async () => {
      videoEl.muted = !videoEl.muted;
      updateMuteBtn();
      try { await videoEl.play(); } catch(e) {}
    });

    volSlider.addEventListener("input", () => {
      videoEl.volume = parseFloat(volSlider.value || "0.8");
      if (videoEl.volume > 0) videoEl.muted = false;
      updateMuteBtn();
    });

    fsBtn.addEventListener("click", async () => {
      try {
        if (document.fullscreenElement) await document.exitFullscreen();
        else await videoEl.requestFullscreen();
      } catch(e) {}
    });

    // ---------- chat open/close ----------
    function setChatOpen(open){
      if (open){
        chatDock.style.display = "block";
        chatOpenBtn.style.display = "none";
        document.body.classList.remove("chat-closed");
      } else {
        chatDock.style.display = "none";
        chatOpenBtn.style.display = "block";
        document.body.classList.add("chat-closed");
      }
      localStorage.setItem("fs_chat_open", open ? "1" : "0");
    }
    setChatOpen(localStorage.getItem("fs_chat_open") !== "0");
    chatCloseBtn.addEventListener("click", () => setChatOpen(false));
    chatOpenBtn.addEventListener("click", () => setChatOpen(true));

    // ---------- HLS / source switching ----------
    let hls = null;
    function destroyHls(){ if (hls) { hls.destroy(); hls = null; } }

    let currentVideoId = null;
    let currentSrc = null;
    let currentIsHls = false;
    let switching = false;
    let holdingEnded = false;

    function cleanSwap(){
      switching = true;
      holdingEnded = false;
      try { videoEl.pause(); } catch(e) {}
      destroyHls();
      videoEl.removeAttribute("src");
      videoEl.load();
    }

    function attachSource(url, isHls){
      destroyHls();
      currentIsHls = !!isHls;
      videoEl.loop = false;

      if (currentIsHls) {
        if (videoEl.canPlayType("application/vnd.apple.mpegurl")) {
          videoEl.src = url;
          setQuality("Quality: HLS (Safari auto)");
        } else if (window.Hls) {
          hls = new Hls({
            enableWorker: true,
            capLevelToPlayerSize: true,
          });
          hls.loadSource(url);
          hls.attachMedia(videoEl);

          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            const levels = hls.levels || [];
            if (!levels.length) return setQuality("Quality: HLS");
            const best = levels.length - 1;
            hls.currentLevel = best;
            hls.loadLevel = best;
            const L = levels[best];
            const label = L?.height ? `${L.height}p` : `L${best}`;
            setQuality(`Quality: ${label} (locked)`);
          });
        } else {
          videoEl.src = "";
          setQuality("Quality: HLS unsupported");
        }
      } else {
        videoEl.src = url;
        const updateQ = () => {
          const h = videoEl.videoHeight || 0;
          setQuality(h ? `Quality: ${h}p (MP4)` : "Quality: MP4");
        };
        videoEl.addEventListener("loadedmetadata", updateQ, { once:true });
        videoEl.addEventListener("resize", updateQ);
      }
    }

    // If the browser fails to load/decode -> force a resync (prevents ‚Äúblack forever‚Äù)
    videoEl.addEventListener("error", () => {
      setQuality("Quality: error (retrying)");
      setTimeout(() => syncNow().catch(()=>{}), 400);
    });

    videoEl.addEventListener("ended", () => {
      holdingEnded = true;
      try { videoEl.pause(); } catch(e) {}
      syncNow().catch(()=>{});
    });

    // ---------- reactions ----------
    function votedKey(videoId){ return `fs_voted_${videoId}`; }

    function bubble(emoji){
      const b = document.createElement("div");
      b.className = "bubble";
      b.textContent = emoji;
      document.body.appendChild(b);
      setTimeout(() => b.remove(), 1200);
    }

    async function refreshReactions(){
      if (!currentVideoId) return;
      try{
        const res = await fetch(REACTION_STATE_URL(currentVideoId), {
          cache:"no-store",
          headers: { "X-Client-Id": CLIENT_ID }
        });
        if (!res.ok) return;
        const data = await res.json();
        if (!data.ok) return;

        fireCount.textContent = data.counts?.fire ?? 0;
        nahCount.textContent  = data.counts?.nah  ?? 0;

        const votedLocal = localStorage.getItem(votedKey(currentVideoId));
        const voted = data.voted || votedLocal;

        if (voted){
          fireBtn.disabled = true;
          nahBtn.disabled = true;
          rxNote.textContent = "voted";
        } else {
          fireBtn.disabled = false;
          nahBtn.disabled = false;
          rxNote.textContent = "Vote once per video";
        }
      }catch(e){}
    }

    async function vote(reaction){
      if (!currentVideoId) return;
      if (localStorage.getItem(votedKey(currentVideoId))) return;

      try{
        const res = await fetch(REACTION_VOTE_URL, {
          method:"POST",
          headers: {
            "Content-Type":"application/json",
            "X-CSRFToken": CSRF_TOKEN
          },
          body: JSON.stringify({ video_id: currentVideoId, reaction, client_id: CLIENT_ID })
        });
        const data = await res.json();
        if (!data.ok && !data.already_voted) return;

        localStorage.setItem(votedKey(currentVideoId), reaction);
        bubble(reaction === "fire" ? "üî•" : "üö´");
        await refreshReactions();
      }catch(e){}
    }

    fireBtn.addEventListener("click", () => vote("fire"));
    nahBtn.addEventListener("click", () => vote("nah"));
    setInterval(refreshReactions, 2500);

    // ---------- NOW sync ----------
    async function fetchNow(){
      const res = await fetch(NOW_URL, { cache:"no-store" });
      if (!res.ok) throw new Error("now.json failed");
      return await res.json();
    }

    // ‚úÖ FIXED: supports item.id (what your API returns), item.video_id (older), and falls back to src compare
    async function syncNow(){
      const data = await fetchNow();

      // be compatible with any key name
      const item = data?.current || data?.item || data?.now;
      if (!item?.play_url) return;

      const nextSrc = String(item.play_url);
      const nextIsHls = !!item.is_hls;

      // FIX: your tv_api_views returns "id" for the video
      const nextId = String(item.id || item.video_id || "");

      const videoChanged =
        (nextId && nextId !== String(currentVideoId || "")) ||
        (!nextId && nextSrc !== String(currentSrc || ""));

      const offset = Number(data.offset_seconds || 0);

      if (videoChanged) {
        cleanSwap();

        currentVideoId = nextId || null;
        currentSrc = nextSrc;
        currentIsHls = nextIsHls;

        attachSource(nextSrc, nextIsHls);

        const onMeta = async () => {
          videoEl.removeEventListener("loadedmetadata", onMeta);
          switching = false;

          // only seek for MP4
          if (!nextIsHls && offset > 0) {
            try { videoEl.currentTime = Math.max(0, Math.floor(offset)); } catch(e) {}
          }

          holdingEnded = false;
          try { await videoEl.play(); } catch(e) {}

          refreshReactions();
        };

        videoEl.addEventListener("loadedmetadata", onMeta);

        // kick playback asap
        try { await videoEl.play(); } catch(e) {}
        return;
      }

      // if same video, keep it in sync
      if (!currentIsHls && offset > 0 && !videoEl.seeking && !switching) {
        const ct = Number(videoEl.currentTime || 0);
        const behind = offset - ct;
        if (behind > SEEK_FORWARD_IF_BEHIND_SEC) {
          try { videoEl.currentTime = Math.max(0, Math.floor(offset)); } catch(e) {}
          return;
        }
      }

      if (holdingEnded) {
        try { videoEl.pause(); } catch(e) {}
        return;
      }
    }

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible") {
        syncNow().catch(()=>{});
        videoEl.play().catch(()=>{});
      }
    });

    // ---------- Chat ----------
    let lastChatId = 0;

    function appendMsg(m){
      const div = document.createElement("div");
      div.className = "msg";
      div.innerHTML = `<span class="u">${escapeHtml(m.username)}</span><span class="t">${escapeHtml(m.message)}</span>`;
      chatList.appendChild(div);
      chatList.scrollTop = chatList.scrollHeight;
    }

    async function pollChat(){
      try{
        const res = await fetch(CHAT_POLL_URL(lastChatId), { cache:"no-store" });
        if (!res.ok) return;
        const data = await res.json();
        const items = Array.isArray(data.items) ? data.items : [];
        for (const m of items){
          lastChatId = Math.max(lastChatId, m.id || 0);
          appendMsg(m);
        }
      }catch(e){}
    }
    setInterval(pollChat, CHAT_POLL_MS);
    pollChat();

    async function sendChat(){
      const msg = (chatInput.value || "").trim();
      if (!msg) return;
      chatInput.value = "";
      try{
        await fetch(CHAT_SEND_URL, {
          method:"POST",
          headers: { "Content-Type":"application/json", "X-CSRFToken": CSRF_TOKEN },
          body: JSON.stringify({ username: GUEST, message: msg })
        });
      }catch(e){}
    }
    sendBtn.addEventListener("click", sendChat);
    chatInput.addEventListener("keydown", (e) => { if (e.key === "Enter") sendChat(); });

    // ---------- Presence / viewers ----------
    async function pingPresence(){
      try{
        const res = await fetch(PRESENCE_PING_URL(SID), { cache:"no-store" });
        if (!res.ok) { viewerCountEl.textContent = String(VIEW_BASE); return; }
        const data = await res.json();
        const live = Number(data.viewers ?? 0) || 0;
        viewerCountEl.textContent = String(VIEW_BASE + live);
      }catch(e){
        viewerCountEl.textContent = String(VIEW_BASE);
      }
    }

    // ---------- boot ----------
    syncNow().catch(()=>{});
    setInterval(() => syncNow().catch(()=>{}), POLL_MS);

    pingPresence();
    setInterval(pingPresence, 10000);
  </script>
</body>
</html>
