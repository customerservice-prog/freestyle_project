<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Freestyle Live</title>
  <style>
    html, body { margin:0; height:100%; background:#000; }
    video { width:100%; height:100%; object-fit:contain; background:#000; }
    #msg { position:fixed; left:10px; top:10px; color:#fff; font-family:Arial;
           background:rgba(0,0,0,.6); padding:10px; border-radius:10px; }
    #tap { position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
           color:#fff; font-family:Arial; background:rgba(0,0,0,.7);
           padding:14px 18px; border-radius:14px; display:none; cursor:pointer; }
  </style>
</head>
<body>
  <div id="msg">Loading…</div>
  <div id="tap">Tap to Start</div>
  <video id="v" playsinline muted autoplay controls></video>

  <script>
    const msg = document.getElementById("msg");
    const tap = document.getElementById("tap");
    const v = document.getElementById("v");

    async function loadNow() {
      msg.textContent = "Fetching now.json…";
      const r = await fetch("/api/freestyle/channel/main/now.json", { cache: "no-store" });
      const data = await r.json();
      console.log("now.json:", data);

      const item = data.item;
      if (!item) { msg.textContent = "No item returned"; return; }

      const url = item.play_url || "";
      if (!url) { msg.textContent = "play_url is EMPTY (backend issue)"; return; }

      msg.textContent = "Loading video: " + url;
      v.src = url;
      v.load();

      try {
        await v.play();
        tap.style.display = "none";
        msg.textContent = "Playing ✅";
      } catch(e) {
        msg.textContent = "Autoplay blocked — tap to start";
        tap.style.display = "block";
      }
    }

    tap.onclick = async () => {
      v.muted = false;
      try { await v.play(); tap.style.display="none"; msg.textContent="Playing ✅"; } catch(e){}
    };

    loadNow();
    setInterval(loadNow, 5000);
  </script>
</body>
</html>
