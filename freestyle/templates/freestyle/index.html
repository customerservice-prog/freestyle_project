{% load static %}
<!doctype html>
<html lang="en" data-channel="main">
<head>
  <meta charset="utf-8" />
  <title>Freestyle TV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; overflow:hidden; }
    #player { width:100vw; height:100vh; background:#000; object-fit:contain; }

    .badge { position:fixed; top:10px; left:10px; z-index:9999; display:flex; gap:8px; flex-wrap:wrap; }
    .badge a{ color:#fff; font-family:Arial,sans-serif; font-size:14px; background:rgba(0,0,0,.45); padding:8px 10px; border-radius:8px; text-decoration:none; }

    /* Logo */
    #logo{
      position:fixed; top:14px; right:14px; height:320px; width:auto;
      z-index:9999; pointer-events:none; opacity:.98;
      filter: drop-shadow(0 0 20px rgba(0,170,255,.35)) drop-shadow(0 0 60px rgba(0,170,255,.18));
      animation: glow 3.2s ease-in-out infinite;
      transform-origin: 50% 50%;
    }
    @keyframes glow{
      0%,100%{ filter: drop-shadow(0 0 14px rgba(0,170,255,.20)) drop-shadow(0 0 42px rgba(0,170,255,.12)); }
      50%{ filter: drop-shadow(0 0 28px rgba(0,170,255,.65)) drop-shadow(0 0 95px rgba(0,170,255,.26)); }
    }

    /* Fancy Now Playing Banner */
    #nowBanner{
      position:fixed; top:14px; left:50%; transform:translateX(-50%);
      z-index:9998;
      width:min(980px, calc(100% - 520px));
      padding:12px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(135deg, rgba(60,130,255,.22), rgba(255,70,160,.12), rgba(0,0,0,.55));
      backdrop-filter: blur(14px);
      box-shadow: 0 18px 70px rgba(0,0,0,.55);
      display:none;
      color:#fff;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .nb-row{ display:flex; align-items:center; gap:12px; }
    .nb-live{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      letter-spacing:.12em;
      font-size:12px;
      background: rgba(220,38,38,.16);
      border: 1px solid rgba(220,38,38,.45);
      white-space:nowrap;
    }
    .nb-mid{ flex:1; min-width:0; }
    .nb-label{ font-size:11px; letter-spacing:.18em; opacity:.85; font-weight:900; }
    .nb-title{
      margin-top:2px;
      font-size:15px;
      font-weight:950;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .nb-meta{ margin-top:4px; display:flex; gap:10px; align-items:center; opacity:.85; font-size:12px; font-weight:800; }
    .nb-bar{ height:6px; margin-top:8px; background:rgba(255,255,255,.10); border-radius:999px; overflow:hidden; }
    .nb-fill{ height:100%; width:0%; background: rgba(0,170,255,.75); }

    .nb-rx{ display:flex; gap:10px; align-items:center; }
    .rxBtnMini{
      display:flex; align-items:center; gap:8px;
      border-radius:999px;
      padding:8px 12px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.25);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .rxBtnMini:active{ transform:scale(.98); }

    /* Viewers pill */
    #viewersPill{
      position:fixed;
      right:14px;
      bottom: 412px; /* when chat is open */
      z-index:10001;
      display:none;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(0,0,0,.50);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 40px rgba(0,0,0,.55);
      color:#fff;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-weight:900;
    }
    #viewersPill.chatClosed{
      bottom:14px; /* ‚úÖ bottom right when chat closed */
    }
    #viewersPill .muted{ opacity:.85; font-weight:800; }

    /* Paid Ad card */
    #adCard{
      position:fixed;
      right:14px;
      top: 360px;
      z-index:9999;
      width:360px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,210,80,.20), rgba(60,130,255,.12), rgba(0,0,0,.55));
      backdrop-filter: blur(14px);
      box-shadow: 0 22px 90px rgba(0,0,0,.65);
      overflow:hidden;
      display:none;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    #adClose{
      position:absolute; top:10px; right:10px;
      width:30px; height:30px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.35);
      color:#fff;
      cursor:pointer;
      z-index:2;
    }
    #adLink{ display:block; text-decoration:none; color:#fff; }
    .adHead{ padding:14px 14px 8px 14px; }
    .adPaid{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      letter-spacing:.14em;
      font-weight:950;
      font-size:11px;
    }
    #adTitle{ margin-top:10px; font-size:16px; font-weight:950; }
    #adSub{ margin-top:4px; font-size:12px; opacity:.85; font-weight:800; }
    .adBody{ padding:10px 14px 14px 14px; display:flex; gap:12px; }
    #adImg{
      width:108px; height:108px;
      object-fit:cover;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      display:none;
    }
    #adDesc{
      flex:1;
      font-size:12px;
      opacity:.92;
      line-height:1.35;
      font-weight:700;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp: 6;
      -webkit-box-orient: vertical;
    }

    /* Bottom controls */
    .tv-controls{
      position:fixed; bottom:14px; left:14px; z-index:9999;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:12px;
      background:rgba(0,0,0,.40); backdrop-filter: blur(6px);
      border:1px solid rgba(255,255,255,.10);
    }
    .tv-btn{
      color:#fff; font-family:Arial,sans-serif; font-size:14px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(255,255,255,.06);
      padding:8px 10px; border-radius:10px;
      cursor:pointer; user-select:none;
    }
    .tv-vol{ display:flex; align-items:center; gap:8px; color:#fff; font-family:Arial; font-size:13px; }
    .tv-vol input[type="range"]{ width:150px; cursor:pointer; }

    /* Chat dock */
    #chatDock{
      position:fixed; right:14px; bottom:14px; z-index:10000;
      width:min(360px, 94vw);
      border-radius:16px;
      background: rgba(0,0,0,.40);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0,170,255,.18);
      box-shadow: 0 14px 50px rgba(0,0,0,.55);
      overflow:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    #chatHeader{
      padding:10px 12px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: linear-gradient(90deg, rgba(0,170,255,.10), rgba(0,0,0,0));
      color:#fff;
      font-weight:900;
      letter-spacing:.3px;
    }
    #chatMeta{ font-size:12px; opacity:.8; font-weight:700; display:flex; align-items:center; gap:10px; }
    #chatClose{
      width:28px; height:28px; border-radius:10px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.35);
      color:#fff; cursor:pointer;
      font-weight:900;
      line-height:0;
    }

    #reactionBar{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between;
      color:#fff;
      gap:10px;
    }
    .rxBtns{ display:flex; gap:10px; align-items:center; }
    .rxBtn{
      display:flex; align-items:center; gap:8px;
      border-radius:12px;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
      font-weight:800;
      transition: transform .08s ease;
    }
    .rxBtn:active{ transform: scale(.98); }
    .rxCount{ opacity:.9; font-weight:900; }
    .rxNote{ font-size:12px; opacity:.75; font-weight:700; }

    #chatList{ height:220px; overflow:auto; padding:10px 10px 6px 10px; color:#fff; }
    .msg{ padding:8px 10px; border-radius:12px; margin-bottom:8px; background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.06); }
    .msg .u{ font-weight:900; color: rgba(0,170,255,.95); }
    .msg .t{ font-weight:700; opacity:.92; margin-left:6px; }

    #chatInputWrap{ padding:10px; border-top:1px solid rgba(255,255,255,.08); display:flex; gap:8px; }
    #chatInput{
      flex:1; border-radius:12px; border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35); color:#fff; padding:10px 10px; outline:none; font-weight:700;
    }
    #sendBtn{
      border-radius:12px; padding:10px 12px;
      border:1px solid rgba(0,170,255,.35);
      background: rgba(0,170,255,.14);
      color:#fff; font-weight:900; cursor:pointer;
    }

    /* Chat open button (when closed) */
    #chatOpenBtn{
      position:fixed;
      right:14px;
      bottom:14px;
      z-index:10000;
      display:none;
      padding:12px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.50);
      color:#fff;
      font-weight:950;
      cursor:pointer;
      box-shadow: 0 12px 40px rgba(0,0,0,.55);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    /* Gate */
    #gate{
      position:fixed; inset:0; z-index:20000;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.72);
      backdrop-filter: blur(10px);
    }
    .gate-card{
      width:min(640px, 92vw);
      background: rgba(10,10,10,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:18px;
      color:#fff;
      font-family: Arial, sans-serif;
      text-align:center;
      box-shadow: 0 10px 40px rgba(0,0,0,.55);
    }
    .gate-card h2{ margin:0 0 8px 0; font-size:22px; }
    .gate-terms{
      text-align:left; font-size:13px; opacity:.92; line-height:1.35;
      max-height:190px; overflow:auto;
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px; padding:10px; margin:12px 0;
      background: rgba(0,0,0,.25);
    }
    #enterBtn{
      padding:10px 14px; border-radius:12px;
      background: rgba(0,170,255,.18);
      border:1px solid rgba(0,170,255,.45);
      color:#fff; font-weight:800;
      cursor:not-allowed; opacity:.45;
      width:100%;
    }
    #enterBtn.enabled{ cursor:pointer; opacity:1; }
  </style>
</head>

<body>
  <div class="badge">
    <a href="/admin/">Submit</a>
    <a href="/manage/">Manage (staff)</a>
    <a href="/creator/">Creator</a>
  </div>

  <img id="logo" src="{% static 'freestyle/img/logo.png' %}" alt="Logo" />

  <!-- Now playing -->
  <div id="nowBanner">
    <div class="nb-row">
      <div class="nb-live">‚óè LIVE</div>

      <div class="nb-mid">
        <div class="nb-label">NOW PLAYING</div>
        <div id="nowTitle" class="nb-title">Loading‚Ä¶</div>
        <div class="nb-meta">
          <span id="nowTime">00:00</span>
          <span style="opacity:.6;">‚Ä¢</span>
          <span id="nowDur">00:00</span>
        </div>
        <div class="nb-bar"><div id="nowFill" class="nb-fill"></div></div>
      </div>

      <div class="nb-rx">
        <button id="fireBtnMini" class="rxBtnMini" type="button">üî• <span id="fireCountMini">0</span></button>
        <button id="nahBtnMini" class="rxBtnMini" type="button">NAH <span id="nahCountMini">0</span></button>
      </div>
    </div>
  </div>

  <!-- Viewers -->
  <div id="viewersPill">
    <span>üëÅ</span>
    <span id="viewersCount">1100</span>
    <span class="muted">watching</span>
  </div>

  <!-- Paid Ad -->
  <div id="adCard">
    <button id="adClose" type="button">√ó</button>
    <a id="adLink" href="#" target="_blank" rel="noopener">
      <div class="adHead">
        <div class="adPaid">PAID SPOT</div>
        <div id="adTitle">Sponsor</div>
        <div id="adSub">Click to visit</div>
      </div>
      <div class="adBody">
        <img id="adImg" alt="Sponsor image" />
        <div id="adDesc"></div>
      </div>
    </a>
  </div>

  <video
    id="player"
    playsinline
    preload="auto"
    muted
    autoplay
    controlslist="nodownload noplaybackrate noremoteplayback"
    disablepictureinpicture
  ></video>

  <div class="tv-controls">
    <button id="muteBtn" class="tv-btn" type="button">Unmute</button>
    <div class="tv-vol">
      <span>Vol</span>
      <input id="volSlider" type="range" min="0" max="1" step="0.01" value="0.8" />
    </div>
    <button id="fsBtn" class="tv-btn" type="button">Fullscreen</button>
  </div>

  <!-- Chat -->
  <div id="chatDock">
    <div id="chatHeader">
      <div>LIVE CHAT</div>
      <div id="chatMeta">
        <span id="guestName">Guest</span>
        <button id="chatClose" type="button">√ó</button>
      </div>
    </div>

    <div id="reactionBar">
      <div class="rxBtns">
        <button id="fireBtn" class="rxBtn" type="button"><span>üî•</span> <span>Fire</span> <span class="rxCount" id="fireCount">0</span></button>
        <button id="nahBtn"  class="rxBtn" type="button"><span>üö´</span> <span>Nah</span>  <span class="rxCount" id="nahCount">0</span></button>
      </div>
      <div class="rxNote" id="rxNote">Vote once per video</div>
    </div>

    <div id="chatList"></div>

    <div id="chatInputWrap">
      <input id="chatInput" placeholder="Say something‚Ä¶" maxlength="500" />
      <button id="sendBtn" type="button">Send</button>
    </div>
  </div>

  <button id="chatOpenBtn" type="button">Chat</button>

  <!-- Gate -->
  <div id="gate">
    <div class="gate-card">
      <h2>Tap to Enter</h2>
      <div style="opacity:.92">Confirm you agree to our Terms before entering.</div>

      <div class="gate-terms">
        <b>Terms Summary (example)</b><br/>
        ‚Ä¢ You confirm you have rights to upload content.<br/>
        ‚Ä¢ You grant us a worldwide, royalty-free license to host, stream, promote, and monetize it.<br/>
        ‚Ä¢ No illegal or infringing uploads.<br/>
        ‚Ä¢ We may remove content at any time.<br/><br/>
        <i>Link your real Terms/Privacy pages.</i>
      </div>

      <label style="display:flex; gap:10px; align-items:flex-start; text-align:left; font-size:13px;">
        <input id="agreeBox" type="checkbox" style="margin-top:3px;" />
        <span>I agree to the Terms, Privacy, and Content Policy.</span>
      </label>

      <button id="enterBtn" type="button" style="margin-top:12px;" disabled>Enter (Enable Audio)</button>
      <div style="font-size:12px; opacity:.7; margin-top:8px;">(Live TV keeps running. This only unlocks audio.)</div>
    </div>
  </div>

  <script>
    // ---------------- config ----------------
    const channelSlug = document.documentElement.dataset.channel || "main";
    const NOW_URL   = `/api/freestyle/channel/${channelSlug}/now.json`;
    const PING_URL  = `/api/freestyle/presence/ping.json`;
    const CHAT_URL  = `/api/freestyle/channel/${channelSlug}/chat.json`;
    const CHAT_SEND = `/api/freestyle/channel/${channelSlug}/chat/send.json`;
    const REACT_URL = `/api/freestyle/channel/${channelSlug}/react.json`;

    const POLL_MS = 2500;
    const CHAT_POLL_MS = 1200;
    const PRESENCE_MS = 15000;

    const BASE_VIEWERS = 1100;

    // drift rules
    const HARD_DRIFT = 6.0;   // seconds (seek)
    const SOFT_DRIFT = 1.0;   // seconds (slight rate)
    const SOFT_RATE  = 0.05;
    const SOFT_HOLD  = 900;

    // ---------------- helpers ----------------
    function escapeHtml(s){
      return (s || "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function fmtTime(sec){
      sec = Math.max(0, Math.floor(sec || 0));
      const m = Math.floor(sec/60);
      const s = sec % 60;
      return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    }
    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

    // ---------------- elements ----------------
    const videoEl   = document.getElementById("player");

    const nowBanner = document.getElementById("nowBanner");
    const nowTitle  = document.getElementById("nowTitle");
    const nowTime   = document.getElementById("nowTime");
    const nowDur    = document.getElementById("nowDur");
    const nowFill   = document.getElementById("nowFill");

    const viewersPill  = document.getElementById("viewersPill");
    const viewersCount = document.getElementById("viewersCount");

    const adCard  = document.getElementById("adCard");
    const adClose = document.getElementById("adClose");
    const adLink  = document.getElementById("adLink");
    const adTitle = document.getElementById("adTitle");
    const adSub   = document.getElementById("adSub");
    const adImg   = document.getElementById("adImg");
    const adDesc  = document.getElementById("adDesc");

    const gateEl   = document.getElementById("gate");
    const agreeBox = document.getElementById("agreeBox");
    const enterBtn = document.getElementById("enterBtn");

    const muteBtn   = document.getElementById("muteBtn");
    const volSlider = document.getElementById("volSlider");
    const fsBtn     = document.getElementById("fsBtn");

    const chatDock  = document.getElementById("chatDock");
    const chatOpenBtn = document.getElementById("chatOpenBtn");
    const chatClose = document.getElementById("chatClose");
    const guestName = document.getElementById("guestName");

    const chatList  = document.getElementById("chatList");
    const chatInput = document.getElementById("chatInput");
    const sendBtn   = document.getElementById("sendBtn");

    const fireBtn   = document.getElementById("fireBtn");
    const nahBtn    = document.getElementById("nahBtn");
    const fireCount = document.getElementById("fireCount");
    const nahCount  = document.getElementById("nahCount");
    const rxNote    = document.getElementById("rxNote");

    const fireBtnMini = document.getElementById("fireBtnMini");
    const nahBtnMini  = document.getElementById("nahBtnMini");
    const fireCountMini = document.getElementById("fireCountMini");
    const nahCountMini  = document.getElementById("nahCountMini");

    // ---------------- ids ----------------
    function getSid(){
      let x = localStorage.getItem("fs_sid");
      if (!x){
        x = (crypto?.randomUUID ? crypto.randomUUID() : ("sid_" + Math.random().toString(16).slice(2)));
        localStorage.setItem("fs_sid", x);
      }
      return x;
    }
    const SID = getSid();

    function getGuest(){
      let g = localStorage.getItem("fs_guest_name");
      if (!g){
        g = "Guest-" + Math.floor(1000 + Math.random()*9000);
        localStorage.setItem("fs_guest_name", g);
      }
      return g;
    }
    const GUEST = getGuest();
    guestName.textContent = GUEST;

    // ---------------- hls ----------------
    let hls = null;
    function destroyHls(){ if (hls) { hls.destroy(); hls = null; } }

    function attachSource(url){
      destroyHls();
      if (!url){ videoEl.src = ""; return; }

      const isHls = url.includes(".m3u8");
      if (isHls){
        if (videoEl.canPlayType("application/vnd.apple.mpegurl")) {
          videoEl.src = url;
        } else if (window.Hls) {
          hls = new Hls({ enableWorker:true });
          hls.loadSource(url);
          hls.attachMedia(videoEl);
        } else {
          console.warn("HLS not supported.");
          videoEl.src = "";
        }
      } else {
        videoEl.src = url;
      }
    }

    // ---------------- live clock ----------------
    let baseOffset = 0;
    let basePerf = 0;
    let baseSet = false;

    function setBase(offsetSeconds){
      baseOffset = Math.max(0, Number(offsetSeconds) || 0);
      basePerf = performance.now();
      baseSet = true;
    }
    function desiredTime(){
      if (!baseSet) return 0;
      return Math.max(0, baseOffset + (performance.now() - basePerf) / 1000);
    }

    let softTimer = null;
    function setSoftRate(r){
      clearTimeout(softTimer);
      videoEl.playbackRate = r;
      softTimer = setTimeout(() => videoEl.playbackRate = 1.0, SOFT_HOLD);
    }

    // ---------------- state ----------------
    let lastPlayUrl = null;
    let lastStartEpoch = 0;
    let allowSeekUntil = 0;

    function allowProgrammaticSeek(ms, fn){
      allowSeekUntil = Date.now() + ms;
      fn();
    }

    // ---------------- UI: chat open/close + viewer positioning ----------------
    function setChatOpen(open){
      if (open){
        chatDock.style.display = "block";
        chatOpenBtn.style.display = "none";
        viewersPill.classList.remove("chatClosed");
        localStorage.setItem("fs_chat_open", "1");
      } else {
        chatDock.style.display = "none";
        chatOpenBtn.style.display = "block";
        viewersPill.classList.add("chatClosed");
        localStorage.setItem("fs_chat_open", "0");
      }
    }
    chatClose.addEventListener("click", () => setChatOpen(false));
    chatOpenBtn.addEventListener("click", () => setChatOpen(true));
    setChatOpen(localStorage.getItem("fs_chat_open") !== "0");

    // ---------------- UI: mute/volume/fullscreen ----------------
    videoEl.muted = true;
    videoEl.volume = parseFloat(volSlider.value);
    videoEl.controls = false;

    function updateMuteBtn(){ muteBtn.textContent = videoEl.muted ? "Unmute" : "Mute"; }
    updateMuteBtn();

    muteBtn.addEventListener("click", async () => {
      videoEl.muted = !videoEl.muted;
      updateMuteBtn();
      try { await videoEl.play(); } catch(e) {}
    });

    volSlider.addEventListener("input", () => {
      videoEl.volume = parseFloat(volSlider.value);
      if (videoEl.volume > 0) videoEl.muted = false;
      updateMuteBtn();
    });

    fsBtn.addEventListener("click", async () => {
      try {
        if (document.fullscreenElement) await document.exitFullscreen();
        else await videoEl.requestFullscreen();
      } catch(e) {}
    });

    // keep "live tv" playing
    videoEl.addEventListener("pause", () => setTimeout(() => videoEl.play().catch(()=>{}), 150));

    // prevent user scrubbing
    videoEl.addEventListener("seeking", () => {
      if (Date.now() < allowSeekUntil) return;
      if (!baseSet) return;
      const want = desiredTime();
      allowProgrammaticSeek(900, () => { videoEl.currentTime = want; });
    });

    // ---------------- Gate ----------------
    function setEnterEnabled(on){
      enterBtn.disabled = !on;
      enterBtn.classList.toggle("enabled", !!on);
    }
    setEnterEnabled(false);
    agreeBox.addEventListener("change", () => setEnterEnabled(agreeBox.checked));

    enterBtn.addEventListener("click", async () => {
      gateEl.style.display = "none";
      videoEl.muted = false;
      updateMuteBtn();
      try { await videoEl.play(); } catch(e) {}
    });

    // ---------------- Presence ----------------
    async function pingPresence(){
      try{
        await fetch(`${PING_URL}?sid=${encodeURIComponent(SID)}&channel=${encodeURIComponent(channelSlug)}`, { cache:"no-store" });
      }catch(e){}
    }

    // ---------------- Now polling ----------------
    async function fetchNow(){
      const res = await fetch(NOW_URL, { cache:"no-store" });
      if (!res.ok) throw new Error(`now.json ${res.status}`);
      return await res.json();
    }

    function applySponsor(s){
      const has = s && (s.url || s.title || s.image_url || s.description);
      if (!has){
        adCard.style.display = "none";
        return;
      }
      adLink.href = s.url || "#";
      adTitle.textContent = s.title || "Sponsor";
      adSub.textContent = s.subtitle || "Click to visit sponsor";
      adDesc.textContent = (s.description || "").trim();

      if (s.image_url){
        adImg.src = s.image_url;
        adImg.style.display = "block";
      } else {
        adImg.style.display = "none";
      }
      adCard.style.display = "block";
    }

    adClose.addEventListener("click", () => { adCard.style.display = "none"; });

    function applyViewers(realCount){
      const n = BASE_VIEWERS + Math.max(0, Number(realCount || 0));
      viewersCount.textContent = String(n);
      viewersPill.style.display = "inline-flex";
    }

    async function applyNow(data){
      if (!data || !data.ok) return;

      nowBanner.style.display = "block";
      nowTitle.textContent = data.title || "‚Äî";

      // base + real
      applyViewers(data.viewers || 0);

      // sponsor
      applySponsor(data.sponsor || {});

      // votes
      const f = data.votes?.fire ?? 0;
      const n = data.votes?.nah ?? 0;
      fireCount.textContent = f; nahCount.textContent = n;
      fireCountMini.textContent = f; nahCountMini.textContent = n;

      // sync clock
      setBase(Number(data.offset_seconds || 0));

      const playUrl = data.play_url || "";
      const startEpoch = Number(data.start_epoch || 0);

      // if video changed -> load new source and seek to offset
      const changed = (playUrl && playUrl !== lastPlayUrl) || (startEpoch && startEpoch !== lastStartEpoch);

      if (changed){
        lastPlayUrl = playUrl;
        lastStartEpoch = startEpoch;

        attachSource(playUrl);
        videoEl.load();

        const onMeta = async () => {
          videoEl.removeEventListener("loadedmetadata", onMeta);
          const want = desiredTime();
          allowProgrammaticSeek(900, () => { videoEl.currentTime = want; });
          videoEl.playbackRate = 1.0;
          try { await videoEl.play(); } catch(e) {}
        };
        videoEl.addEventListener("loadedmetadata", onMeta);
        try { await videoEl.play(); } catch(e) {}
        return;
      }

      // drift correction without restarting
      if (videoEl.readyState >= 2){
        const want = desiredTime();
        const actual = Number(videoEl.currentTime || 0);
        const drift = want - actual;

        if (Math.abs(drift) > HARD_DRIFT){
          allowProgrammaticSeek(900, () => { videoEl.currentTime = want; });
          videoEl.playbackRate = 1.0;
        } else if (Math.abs(drift) > SOFT_DRIFT){
          setSoftRate(1.0 + (drift > 0 ? SOFT_RATE : -SOFT_RATE));
        } else {
          videoEl.playbackRate = 1.0;
        }
      }

      // banner timer + bar
      const dur = Number(data.duration_seconds || 0) || Number(videoEl.duration || 0);
      const ct = Number(videoEl.currentTime || 0);
      nowTime.textContent = fmtTime(ct);
      nowDur.textContent = fmtTime(dur || 0);
      const pct = (dur > 0) ? clamp((ct/dur)*100, 0, 100) : 0;
      nowFill.style.width = `${pct}%`;
    }

    async function syncNow(){
      try{
        const data = await fetchNow();
        await applyNow(data);
      }catch(e){
        console.warn("now.json failed:", e);
      }
    }

    // ---------------- chat ----------------
    let lastChatId = 0;

    function appendMsg(m){
      const div = document.createElement("div");
      div.className = "msg";
      div.innerHTML = `<span class="u">${escapeHtml(m.username)}</span><span class="t">${escapeHtml(m.text)}</span>`;
      chatList.appendChild(div);
      chatList.scrollTop = chatList.scrollHeight;
    }

    async function pollChat(){
      try{
        const res = await fetch(`${CHAT_URL}?since=${encodeURIComponent(String(lastChatId))}`, { cache:"no-store" });
        if (!res.ok) return;
        const data = await res.json();
        const msgs = Array.isArray(data.messages) ? data.messages : [];
        for (const m of msgs){
          lastChatId = Math.max(lastChatId, m.id || 0);
          appendMsg(m);
        }
      }catch(e){}
    }

    async function sendChat(){
      const text = (chatInput.value || "").trim();
      if (!text) return;
      chatInput.value = "";
      try{
        await fetch(CHAT_SEND, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ sid: SID, username: GUEST, text })
        });
      }catch(e){}
    }

    sendBtn.addEventListener("click", sendChat);
    chatInput.addEventListener("keydown", (e) => { if (e.key === "Enter") sendChat(); });

    // ---------------- reactions ----------------
    async function vote(vote){
      try{
        const res = await fetch(REACT_URL, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ sid: SID, vote })
        });
        const data = await res.json();
        if (!data.ok) return;

        const f = data.votes?.fire ?? 0;
        const n = data.votes?.nah ?? 0;
        fireCount.textContent = f; nahCount.textContent = n;
        fireCountMini.textContent = f; nahCountMini.textContent = n;
        rxNote.textContent = "voted";
      }catch(e){}
    }

    fireBtn.addEventListener("click", () => vote("fire"));
    nahBtn.addEventListener("click", () => vote("nah"));
    fireBtnMini.addEventListener("click", () => vote("fire"));
    nahBtnMini.addEventListener("click", () => vote("nah"));

    // ---------------- start ----------------
    pingPresence();
    syncNow();
    pollChat();

    setInterval(pingPresence, PRESENCE_MS);
    setInterval(syncNow, POLL_MS);
    setInterval(pollChat, CHAT_POLL_MS);

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible"){
        syncNow().catch(()=>{});
        videoEl.play().catch(()=>{});
      }
    });
  </script>
</body>
</html>
